language: clojure

env:
- TAG= `date --utc +%FT%T.%3NZ`.$TRAVIS_BUILD_NUMBER
- IMAGE=clojure-graphql-api

services:
  - docker
  
jdk:
- oraclejdk11

branches:
  only:
  - master

before_script:
- lein eastwood
- lein test

script:
# build and validate docker image
- lein uberjar
- docker build -t clojure-graphql-api .
- docker run -d -p 8888:8888 --name clojure-graphql-api clojure-graphql-api
- docker ps | grep -q clojure-graphql-api

after_success:
- lein ancient
- lein kibit
- lein cloverage --codecov
- bash <(curl -s https://codecov.io/bash)

before_deploy:
- docker --version  # document the version travis is using
- pip install --user awscli # install aws cli w/o sudo
- export PATH=$PATH:$HOME/.local/bin # put aws in the path
- eval $(aws ecr get-login --region us-east-1 --no-include-email | sed 's|https://||') 

deploy:
- docker tag clojure-graphql-api:latest 257169857724.dkr.ecr.eu-central-1.amazonaws.com/$IMAGE:$TAG
- docker push 257169857724.dkr.ecr.eu-central-1.amazonaws.com/$IMAGE:$TAG